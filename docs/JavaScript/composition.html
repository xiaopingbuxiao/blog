<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>被忽略掉的composition event | 小平不小</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="一个前端攻城狮的学习笔记">
    <link rel="preload" href="/assets/css/0.styles.6ca259ee.css" as="style"><link rel="preload" href="/assets/js/app.3eecdbb0.js" as="script"><link rel="preload" href="/assets/js/2.5b9869e2.js" as="script"><link rel="preload" href="/assets/js/15.84a6ff1e.js" as="script"><link rel="preload" href="/assets/js/3.f51a2f18.js" as="script"><link rel="prefetch" href="/assets/js/10.ac23a092.js"><link rel="prefetch" href="/assets/js/11.6bcdbd2c.js"><link rel="prefetch" href="/assets/js/12.1733108b.js"><link rel="prefetch" href="/assets/js/13.e4f4f2b6.js"><link rel="prefetch" href="/assets/js/14.4b2f2007.js"><link rel="prefetch" href="/assets/js/16.2566166b.js"><link rel="prefetch" href="/assets/js/17.b2a78d2a.js"><link rel="prefetch" href="/assets/js/18.2e18a722.js"><link rel="prefetch" href="/assets/js/19.55d8693d.js"><link rel="prefetch" href="/assets/js/20.e714aada.js"><link rel="prefetch" href="/assets/js/21.c5fa56df.js"><link rel="prefetch" href="/assets/js/22.90417807.js"><link rel="prefetch" href="/assets/js/23.5c31d834.js"><link rel="prefetch" href="/assets/js/24.8f99880c.js"><link rel="prefetch" href="/assets/js/25.5ecb582c.js"><link rel="prefetch" href="/assets/js/26.34fbc8b8.js"><link rel="prefetch" href="/assets/js/27.2ab72f50.js"><link rel="prefetch" href="/assets/js/28.3c669d05.js"><link rel="prefetch" href="/assets/js/29.abae87cf.js"><link rel="prefetch" href="/assets/js/30.fa48ac74.js"><link rel="prefetch" href="/assets/js/31.dac4d859.js"><link rel="prefetch" href="/assets/js/32.9869622b.js"><link rel="prefetch" href="/assets/js/4.018a88ef.js"><link rel="prefetch" href="/assets/js/5.acfa6a23.js"><link rel="prefetch" href="/assets/js/6.ef601a80.js"><link rel="prefetch" href="/assets/js/7.fac207cf.js"><link rel="prefetch" href="/assets/js/8.44809fb9.js"><link rel="prefetch" href="/assets/js/9.c0b509c0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6ca259ee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小平不小</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端栈" class="dropdown-title"><span class="title">前端栈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Vue/observer/object.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/promise.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/nodeJS/" class="nav-link">
  nodeJS
</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">
  关于我们
</a></div><div class="nav-item"><a href="https://github.com/xiaopingbuxiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端栈" class="dropdown-title"><span class="title">前端栈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Vue/observer/object.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/promise.html" class="nav-link">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/nodeJS/" class="nav-link">
  nodeJS
</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">
  关于我们
</a></div><div class="nav-item"><a href="https://github.com/xiaopingbuxiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/JavaScript/promise.html" class="sidebar-link">实现一个符合Promise/A+规范的Promise</a></li><li><a href="/JavaScript/脚本化http.html" class="sidebar-link">脚本化http</a></li><li><a href="/JavaScript/bind实现.html" class="sidebar-link">bind 模拟实现</a></li><li><a href="/JavaScript/canvas 合成多张图片.html" class="sidebar-link">canvas 合成多张图片</a></li><li><a href="/JavaScript/composition.html" aria-current="page" class="active sidebar-link">被忽略掉的composition event</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JavaScript/composition.html#composition是什么" class="sidebar-link">composition是什么</a></li><li class="sidebar-sub-header"><a href="/JavaScript/composition.html#el-input中使用" class="sidebar-link">el-input中使用</a></li></ul></li><li><a href="/JavaScript/从element中学习ResizeObserver.html" class="sidebar-link">从element中学习ResizeObserver</a></li><li><a href="/JavaScript/前后端都用得上的cors设置.html" class="sidebar-link">前后端都用得上的cors设置</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="被忽略掉的composition-event"><a href="#被忽略掉的composition-event" class="header-anchor">#</a> 被忽略掉的composition event</h1> <p>最近在学习别人是如何使用<code>Vue</code>来造轮子，因此选择在<code>Vue</code>的 <code>UI</code>框架 <code>Element UI</code>。<code>el-input</code>中有这么一段代码</p> <div class="language-js extra-class"><pre class="language-js"><code> <span class="token function">handleInput</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// input事件的触发  如果是IME事件的合成过程中是不触发input</span>
  <span class="token comment">// should not emit input during composition</span>
  <span class="token comment">// see: https://github.com/ElemeFE/element/issues/10516</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isComposing<span class="token punctuation">)</span> <span class="token keyword">return</span>

  <span class="token comment">// hack for https://github.com/ElemeFE/element/issues/8548</span>
  <span class="token comment">// should remove the following line when we don't support IE</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value <span class="token operator">===</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nativeInputValue<span class="token punctuation">)</span> <span class="token keyword">return</span>

  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$emit</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span> event<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span>

  <span class="token comment">// ensure native input value is controlled</span>
  <span class="token comment">// see: https://github.com/ElemeFE/element/issues/12850</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">$nextTick</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>setNativeInputValue<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p><code>element</code>在处理输入框的<code>input</code>事件的时候，首先进行了一次判断，如果<code>this.isComposing</code>为<code>true</code>的时候是直接进行了<code>return</code>的。也就是说<code>input</code>事件并不是每次触发的时候都进行了向上的事件传递的。第一眼看到这里的时候有那么一点懵的。细看上面的注释<code>should not emit input during composition</code>。在<code>composition</code>触发的时候不应该触发<code>input</code>事件。</p> <h2 id="composition是什么"><a href="#composition是什么" class="header-anchor">#</a> composition是什么</h2> <p><code>composition</code>之前好像是在哪里看到过，但印象并不是那么深刻.</p> <p><code>Composition Event</code>，中文译为复合事件，是 DOM 3 级事件中新添加的一类事件类型，用于处理 IME 的输入序列。IME（Input Method Editor，输入法编辑器）可以让用户输入在物理键盘上找不到的字符。复合事件就是针对检测和处理这种输入而设计的。比如在输入中文的时候，需要通过拼音来组合生成，并不是通过键盘直接选择每一次字符，此时就会用到<code>composition event</code></p> <p><strong><code>composition event</code>包含三个事件</strong></p> <ol><li>compositonstart 在IME的文本复合系统打开时触发。即开始输入拼音时候触发</li> <li>compositionupdate 在插入新字符时触发，同 input 事件触发一样，只是触发的时机早于 input</li> <li>compositionend 输入完成，即选中文字真正输入输入框之后</li></ol> <p>具体看下面的代码</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>input</span> <span class="token attr-name">type</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>text<span class="token punctuation">&quot;</span></span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span><span class="token punctuation">&quot;</span></span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>ipt<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
    <span class="token keyword">const</span> input <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">querySelector</span><span class="token punctuation">(</span><span class="token string">'#ipt'</span><span class="token punctuation">)</span>
    input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'input'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'input事件触发'</span><span class="token punctuation">,</span>e<span class="token punctuation">.</span>target<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'compositionstart'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'componsitionstart触发'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'compositionupdate'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'compositionupdate触发'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    input<span class="token punctuation">.</span><span class="token function">addEventListener</span><span class="token punctuation">(</span><span class="token string">'compositionend'</span><span class="token punctuation">,</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'compositionend触发'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  </span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>输入框中输入中文你好的时候，<code>componsitionstart</code>首先执行一次，之后是<code>compositionupdate</code>和<code>input</code>事件都执行 6 次（5 个字符和最后一次选中文字），最后触发一次<code>compositionend</code>事件。</p> <div class="language- extra-class"><pre class="language-text"><code>componsitionstart触发
compositionupdate触发
input事件触发 n
compositionupdate触发
input事件触发 ni
compositionupdate触发
input事件触发 ni h
compositionupdate触发
input事件触发 ni ha
compositionupdate触发
input事件触发 ni hao
compositionupdate触发
input事件触发 你好
compositionend触发
</code></pre></div><h2 id="el-input中使用"><a href="#el-input中使用" class="header-anchor">#</a> el-input中使用</h2> <p>在我查资料的时候正好看到了 饿了么前端团队的这一篇文章.<a href="https://zhuanlan.zhihu.com/p/26141351" target="_blank" rel="noopener noreferrer">移动端 Web 开发踩坑之旅<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。中间有介绍到 input 的 <code>compositionstart</code> 和 <code>compositionend</code> 事件.(不得不说，真是个良心团队啊！)。上面介绍到的配合<code>input</code>事件的使用方法和<code>Element UI</code>的使用方式一样。设置一个开关来判断当前是否是复合事件。具体实现可以继续查看饿了么的这篇文章<a href="https://zhuanlan.zhihu.com/p/26141351" target="_blank" rel="noopener noreferrer">移动端 Web 开发踩坑之旅<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>反思上面各个事件的执行时机，由于<code>compositionend</code>是晚于最后一次<code>input</code>事件的执行的。因此最上面的代码中如果只是在<code>handleInput</code>中来向上传递事件的话<code>this.$emit('input', event.target.value)</code>，是不会执行的，因为最后一次触发<code>input</code>事件的时候开关<code>isComposing</code>还是为<code>true</code>。所以在<code>el-input</code>同时监听了<code>compositionend</code>事件。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">handleCompositionEnd</span><span class="token punctuation">(</span><span class="token parameter">event</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// IME合成执行完毕之后将开关置为false同时触发input事件</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>isComposing<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>isComposing <span class="token operator">=</span> <span class="token boolean">false</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleInput</span><span class="token punctuation">(</span>event<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>除了<code>Element UI</code>中的使用，此时可以想到很多使用场景，如搜素输入框中，通过和<code>composition event</code>的配合，避免用户在输入中文拼音的时候就一直触发搜索事件的执行。
<div class="gitalk-container"><div id="gitalk-container"></div></div></p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/JavaScript/canvas 合成多张图片.html" class="prev">
        canvas 合成多张图片
      </a></span> <span class="next"><a href="/JavaScript/从element中学习ResizeObserver.html">
        从element中学习ResizeObserver
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.3eecdbb0.js" defer></script><script src="/assets/js/2.5b9869e2.js" defer></script><script src="/assets/js/15.84a6ff1e.js" defer></script><script src="/assets/js/3.f51a2f18.js" defer></script>
  </body>
</html>
