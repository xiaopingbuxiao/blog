<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>实现一个符合Promise/A+规范的Promise | 小平不小</title>
    <meta name="generator" content="VuePress 1.5.3">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="一个前端攻城狮的学习笔记">
    <link rel="preload" href="/assets/css/0.styles.6ca259ee.css" as="style"><link rel="preload" href="/assets/js/app.741f6848.js" as="script"><link rel="preload" href="/assets/js/2.5b9869e2.js" as="script"><link rel="preload" href="/assets/js/8.44809fb9.js" as="script"><link rel="preload" href="/assets/js/3.f51a2f18.js" as="script"><link rel="prefetch" href="/assets/js/10.ac23a092.js"><link rel="prefetch" href="/assets/js/11.6bcdbd2c.js"><link rel="prefetch" href="/assets/js/12.1733108b.js"><link rel="prefetch" href="/assets/js/13.e4f4f2b6.js"><link rel="prefetch" href="/assets/js/14.4b2f2007.js"><link rel="prefetch" href="/assets/js/15.84a6ff1e.js"><link rel="prefetch" href="/assets/js/16.2566166b.js"><link rel="prefetch" href="/assets/js/17.b2a78d2a.js"><link rel="prefetch" href="/assets/js/18.2e18a722.js"><link rel="prefetch" href="/assets/js/19.55d8693d.js"><link rel="prefetch" href="/assets/js/20.e714aada.js"><link rel="prefetch" href="/assets/js/21.c5fa56df.js"><link rel="prefetch" href="/assets/js/22.90417807.js"><link rel="prefetch" href="/assets/js/23.5c31d834.js"><link rel="prefetch" href="/assets/js/24.8f99880c.js"><link rel="prefetch" href="/assets/js/25.5ecb582c.js"><link rel="prefetch" href="/assets/js/26.34fbc8b8.js"><link rel="prefetch" href="/assets/js/27.2ab72f50.js"><link rel="prefetch" href="/assets/js/28.3c669d05.js"><link rel="prefetch" href="/assets/js/29.abae87cf.js"><link rel="prefetch" href="/assets/js/30.fa48ac74.js"><link rel="prefetch" href="/assets/js/31.dac4d859.js"><link rel="prefetch" href="/assets/js/32.9869622b.js"><link rel="prefetch" href="/assets/js/4.018a88ef.js"><link rel="prefetch" href="/assets/js/5.acfa6a23.js"><link rel="prefetch" href="/assets/js/6.ef601a80.js"><link rel="prefetch" href="/assets/js/7.fac207cf.js"><link rel="prefetch" href="/assets/js/9.c0b509c0.js">
    <link rel="stylesheet" href="/assets/css/0.styles.6ca259ee.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">小平不小</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端栈" class="dropdown-title"><span class="title">前端栈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Vue/observer/object.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/promise.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/nodeJS/" class="nav-link">
  nodeJS
</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">
  关于我们
</a></div><div class="nav-item"><a href="https://github.com/xiaopingbuxiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="前端栈" class="dropdown-title"><span class="title">前端栈</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Vue/observer/object.html" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/JavaScript/promise.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  JavaScript
</a></li><li class="dropdown-item"><!----> <a href="/nodeJS/" class="nav-link">
  nodeJS
</a></li></ul></div></div><div class="nav-item"><a href="/about.html" class="nav-link">
  关于我们
</a></div><div class="nav-item"><a href="https://github.com/xiaopingbuxiao" target="_blank" rel="noopener noreferrer" class="nav-link external">
  GitHub
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><a href="/JavaScript/promise.html" aria-current="page" class="active sidebar-link">实现一个符合Promise/A+规范的Promise</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#第一个版本" class="sidebar-link">第一个版本</a></li><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#处理异步的-resolve-reject" class="sidebar-link">处理异步的 resolve/reject</a></li><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#then-方法规范" class="sidebar-link">then 方法规范</a></li><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#then-函数中-onfullfilled-onrejected-返回值" class="sidebar-link">then 函数中 onFullfilled/onRejected 返回值</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#then的回调函数执行的时机" class="sidebar-link">then的回调函数执行的时机</a></li></ul></li><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#完整代码" class="sidebar-link">完整代码</a></li><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#promie实例方法" class="sidebar-link">promie实例方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#catch" class="sidebar-link">catch</a></li><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#finally" class="sidebar-link">finally</a></li></ul></li><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#promise的静态方法" class="sidebar-link">promise的静态方法</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#promise-resolve" class="sidebar-link">Promise.resolve</a></li><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#promise-reject" class="sidebar-link">Promise.reject</a></li><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#promise-race" class="sidebar-link">Promise.race</a></li><li class="sidebar-sub-header"><a href="/JavaScript/promise.html#promise-all" class="sidebar-link">Promise.all</a></li></ul></li></ul></li><li><a href="/JavaScript/脚本化http.html" class="sidebar-link">脚本化http</a></li><li><a href="/JavaScript/bind实现.html" class="sidebar-link">bind 模拟实现</a></li><li><a href="/JavaScript/canvas 合成多张图片.html" class="sidebar-link">canvas 合成多张图片</a></li><li><a href="/JavaScript/composition.html" class="sidebar-link">被忽略掉的composition event</a></li><li><a href="/JavaScript/从element中学习ResizeObserver.html" class="sidebar-link">从element中学习ResizeObserver</a></li><li><a href="/JavaScript/前后端都用得上的cors设置.html" class="sidebar-link">前后端都用得上的cors设置</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="实现一个符合promise-a-规范的promise"><a href="#实现一个符合promise-a-规范的promise" class="header-anchor">#</a> 实现一个符合Promise/A+规范的Promise</h1> <p>Promise的出现有效的解决了js 代码出现回调地狱的问题。从而保证了代码的可读性和整洁性。</p> <p>Promise的使用请参考阮一峰大佬的es6标准入门。<a href="http://es6.ruanyifeng.com/?search=promise&amp;x=0&amp;y=0#docs/promise" target="_blank" rel="noopener noreferrer">Promise 对象<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。Promise的规范参考<a href="http://www.ituring.com.cn/article/66566" target="_blank" rel="noopener noreferrer">Promises/A+规范<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>本篇主要来一步步实现一个符合Promise/A+规范的Promise。</p> <h2 id="第一个版本"><a href="#第一个版本" class="header-anchor">#</a> 第一个版本</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
  self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span>     <span class="token comment">// 当前状态</span>
  self<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span>      <span class="token comment">//resolved状态时的值</span>
  self<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span>     <span class="token comment">//rejected状态时的原因</span>

  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'resolved'</span>
      self<span class="token punctuation">.</span>value <span class="token operator">=</span> value
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span>
      self<span class="token punctuation">.</span>reason <span class="token operator">=</span> reason
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFullifilledFn<span class="token punctuation">,</span> onRejectedFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'resolved'</span><span class="token operator">:</span>
      <span class="token function">onFullifilledFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'rejected'</span><span class="token operator">:</span>
      <span class="token function">onRejectedFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'hello'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>  <span class="token comment">//hello</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>此时已经可以实现一个在发生状态改变时，调用then方法中的对象状态的操作。</p> <p>但是此时我们时无法处理异步的 resolve/reject 的。如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'world'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p1<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'异步调用'</span><span class="token punctuation">)</span>  <span class="token comment">//无输出</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="处理异步的-resolve-reject"><a href="#处理异步的-resolve-reject" class="header-anchor">#</a> 处理异步的 resolve/reject</h2> <p>为了处理异步 resolve/reject，需要修改myPromise的定义，<strong>暂时先使用两个函数在保存异步的方法</strong>。</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
  self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span>     <span class="token comment">// 当前状态</span>
  self<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span>      <span class="token comment">//resolved状态时的值</span>
  self<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span>     <span class="token comment">//rejected状态时的原因</span>
  self<span class="token punctuation">.</span><span class="token function-variable function">onFullifilledFn</span> <span class="token operator">=</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value
  self<span class="token punctuation">.</span><span class="token function-variable function">onRejectedFn</span> <span class="token operator">=</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> error <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'resolved'</span>
      self<span class="token punctuation">.</span>value <span class="token operator">=</span> value
      self<span class="token punctuation">.</span><span class="token function">onFullifilledFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span>
      self<span class="token punctuation">.</span>reason <span class="token operator">=</span> reason
      self<span class="token punctuation">.</span><span class="token function">onRejectedFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFullifilledFn<span class="token punctuation">,</span> onRejectedFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'pending'</span><span class="token operator">:</span>
      self<span class="token punctuation">.</span>onFullifilledFn <span class="token operator">=</span> onFullifilledFn
      self<span class="token punctuation">.</span>onRejectedFn <span class="token operator">=</span> onRejectedFn
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'resolved'</span><span class="token operator">:</span>
      <span class="token function">onFullifilledFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'rejected'</span><span class="token operator">:</span>
      <span class="token function">onRejectedFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">var</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>    <span class="token comment">//11</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="then-方法规范"><a href="#then-方法规范" class="header-anchor">#</a> then 方法规范</h2> <ul><li>当 promise 成功执行时，所有 onFulfilled 需按照其注册顺序依次回调</li> <li>当 promise 被拒绝执行时，所有的 onRejected 需按照其注册顺序依次回调</li> <li>then 方法必须返回一个 promise 对象 并且支持链式调用</li></ul> <p>因此上面的定义的 self.onFullifilledFn / self.onRejectedFn 不符合要求，<strong>因为他们不能实现按照其注册顺序依次回调</strong>。因此需要将 self.onFullifilledFn / self.onRejectedFn 改为数组。具体如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
  self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span>     <span class="token comment">// 当前状态</span>
  self<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span>      <span class="token comment">//resolved状态时的值</span>
  self<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span>     <span class="token comment">//rejected状态时的原因</span>
  self<span class="token punctuation">.</span>onFullifilledCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  self<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'resolved'</span>
      self<span class="token punctuation">.</span>value <span class="token operator">=</span> value
      self<span class="token punctuation">.</span>onFullifilledCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span>
      self<span class="token punctuation">.</span>reason <span class="token operator">=</span> reason
      self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFullifilledFn<span class="token punctuation">,</span> onRejectedFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  onFullifilledFn <span class="token operator">=</span> <span class="token keyword">typeof</span> onFullifilledFn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFullifilledFn</span> <span class="token operator">:</span> <span class="token parameter">value</span> <span class="token operator">=&gt;</span> value
  onRejectedFn <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejectedFn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejectedFn</span> <span class="token operator">:</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> error <span class="token punctuation">}</span>
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> promise2<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'pending'</span><span class="token operator">:</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>onFullifilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onFullifilledFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onRejectedFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'resolved'</span><span class="token operator">:</span>
      <span class="token comment">// onFullifilledFn(self.value)</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onFullifilledFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'rejected'</span><span class="token operator">:</span>
      <span class="token comment">// onRejectedFn(self.reason)</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onRejectedFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> promise2
<span class="token punctuation">}</span>

<span class="token keyword">var</span> p3 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p3<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'第一次then调用'</span><span class="token punctuation">)</span>   <span class="token comment">//11  第一次then调用</span>
  <span class="token keyword">return</span> res <span class="token operator">*</span> <span class="token number">2</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'第二次then调用'</span><span class="token punctuation">)</span><span class="token comment">//22  第二次then调用</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h2 id="then-函数中-onfullfilled-onrejected-返回值"><a href="#then-函数中-onfullfilled-onrejected-返回值" class="header-anchor">#</a> then 函数中 onFullfilled/onRejected 返回值</h2> <p>上面的实现方式，我们来看一下下面的调用:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> p4 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">11</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
p4<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'第一次then调用'</span><span class="token punctuation">)</span>    <span class="token comment">//11</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>res <span class="token operator">*</span> <span class="token number">2</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">,</span> <span class="token string">'第二次then调用'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>输入结果如下，发现是又问题的。
<img src="data:image/png;base64,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" alt="MyPromise"></p> <p>先来看promise对于onFullfilled 的要求</p> <ol><li>如果onFullfilled函数返回的是该promise本身，那么会抛出类型错误</li> <li>如果onFullfilled函数返回的是一个不同的promise，那么执行该promise的then函数，在then函数里将这个promise的状态转移给新的promise</li> <li>如果返回的是一个嵌套类型的promsie，那么需要递归。</li> <li>如果返回的是非promsie的对象或者函数，那么会选择直接将该对象或者函数，给新的promise。</li></ol> <p>根据要求，从新定义resolve函数，promise/A+中称这个函数为resolvePromise</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>  
    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Cyclic reference&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> isUsed<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>isUsed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
          isUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> v<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>isUsed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
          isUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUsed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      isUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>同时更改then函数</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFullifilledFn<span class="token punctuation">,</span> onRejectedFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  onFullifilledFn <span class="token operator">=</span> <span class="token keyword">typeof</span> onFullifilledFn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFullifilledFn</span> <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x <span class="token punctuation">}</span>
  onRejectedFn <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejectedFn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejectedFn</span> <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> e <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> promise2<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'pending'</span><span class="token operator">:</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>onFullifilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onFullifilledFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onRejectedFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'resolved'</span><span class="token operator">:</span>
      <span class="token comment">// onFullifilledFn(self.value)</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onFullifilledFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'rejected'</span><span class="token operator">:</span>
      <span class="token comment">// onRejectedFn(self.reason)</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onRejectedFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> promise2
<span class="token punctuation">}</span>
</code></pre></div><p>此时如下的调用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'宏任务首先输出'</span><span class="token punctuation">)</span>
<span class="token comment">//1 </span>
<span class="token comment">//宏任务首先输出</span>

</code></pre></div><h3 id="then的回调函数执行的时机"><a href="#then的回调函数执行的时机" class="header-anchor">#</a> then的回调函数执行的时机</h3> <p><strong>此时发现js的输出顺序是有问题的。应该是先输出宏任务的 ，再输出微任务才对。</strong>
由于我们实现的Promise不能实现微任务的操作。因此我们需要使用 setTimeout 来进行模拟。使then函数的回调函数晚于宏任务(同步代码)执行。</p> <p>具体如下:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFullifilledFn<span class="token punctuation">,</span> onRejectedFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  onFullifilledFn <span class="token operator">=</span> <span class="token keyword">typeof</span> onFullifilledFn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFullifilledFn</span> <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x <span class="token punctuation">}</span>
  onRejectedFn <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejectedFn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejectedFn</span> <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> e <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> promise2<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'pending'</span><span class="token operator">:</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>onFullifilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onFullifilledFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onRejectedFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'resolved'</span><span class="token operator">:</span>
      <span class="token comment">// onFullifilledFn(self.value)</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onFullifilledFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'rejected'</span><span class="token operator">:</span>
      <span class="token comment">// onRejectedFn(self.reason)</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onRejectedFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> promise2
<span class="token punctuation">}</span>
</code></pre></div><h2 id="完整代码"><a href="#完整代码" class="header-anchor">#</a> 完整代码</h2> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">MyPromise</span><span class="token punctuation">(</span><span class="token parameter">executor</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> self <span class="token operator">=</span> <span class="token keyword">this</span>
  self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'pending'</span>     <span class="token comment">// 当前状态</span>
  self<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token keyword">undefined</span>      <span class="token comment">//resolved状态时的值</span>
  self<span class="token punctuation">.</span>reason <span class="token operator">=</span> <span class="token keyword">undefined</span>     <span class="token comment">//rejected状态时的原因</span>
  self<span class="token punctuation">.</span>onFullifilledCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  self<span class="token punctuation">.</span>onRejectedCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'resolved'</span>
      self<span class="token punctuation">.</span>value <span class="token operator">=</span> value
      self<span class="token punctuation">.</span>onFullifilledCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">function</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token string">'pending'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      self<span class="token punctuation">.</span>status <span class="token operator">=</span> <span class="token string">'rejected'</span>
      self<span class="token punctuation">.</span>reason <span class="token operator">=</span> reason
      self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">cb</span> <span class="token operator">=&gt;</span> <span class="token function">cb</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token function">executor</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">then</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFullifilledFn<span class="token punctuation">,</span> onRejectedFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  onFullifilledFn <span class="token operator">=</span> <span class="token keyword">typeof</span> onFullifilledFn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onFullifilledFn</span> <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">x</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">return</span> x <span class="token punctuation">}</span>
  onRejectedFn <span class="token operator">=</span> <span class="token keyword">typeof</span> onRejectedFn <span class="token operator">===</span> <span class="token string">'function'</span> <span class="token operator">?</span> <span class="token function-variable function">onRejectedFn</span> <span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token keyword">throw</span> e <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> self <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
  <span class="token keyword">let</span> promise2<span class="token punctuation">;</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>self<span class="token punctuation">.</span>status<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">'pending'</span><span class="token operator">:</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        self<span class="token punctuation">.</span>onFullifilledCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onFullifilledFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        self<span class="token punctuation">.</span>onRejectedCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
              <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onRejectedFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
              <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'resolved'</span><span class="token operator">:</span>
      <span class="token comment">// onFullifilledFn(self.value)</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onFullifilledFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>value<span class="token punctuation">)</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">'rejected'</span><span class="token operator">:</span>
      <span class="token comment">// onRejectedFn(self.reason)</span>
      promise2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">let</span> temp <span class="token operator">=</span> <span class="token function">onRejectedFn</span><span class="token punctuation">(</span>self<span class="token punctuation">.</span>reason<span class="token punctuation">)</span>
            <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise2<span class="token punctuation">,</span> temp<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">default</span><span class="token operator">:</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> promise2
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">resolvePromise</span><span class="token punctuation">(</span><span class="token parameter">promise<span class="token punctuation">,</span> x<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>promise <span class="token operator">===</span> x<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">reject</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TypeError</span><span class="token punctuation">(</span><span class="token string">&quot;Cyclic reference&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> isUsed<span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>x <span class="token operator">!==</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&quot;object&quot;</span> <span class="token operator">||</span> <span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> then <span class="token operator">=</span> x<span class="token punctuation">.</span>then<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> then <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//</span>
        <span class="token function">then</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>x<span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">v</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>isUsed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
          isUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">resolvePromise</span><span class="token punctuation">(</span>promise<span class="token punctuation">,</span> v<span class="token punctuation">,</span> resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">e</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>isUsed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
          isUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isUsed<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
      isUsed <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

MyPromise<span class="token punctuation">.</span><span class="token function-variable function">deferred</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> dfd <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  dfd<span class="token punctuation">.</span>promise <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    dfd<span class="token punctuation">.</span>resolve <span class="token operator">=</span> resolve<span class="token punctuation">;</span>
    dfd<span class="token punctuation">.</span>reject <span class="token operator">=</span> reject<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> dfd<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MyPromise<span class="token punctuation">;</span>
</code></pre></div><p>测试：</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>npm install <span class="token operator">-</span>g promises<span class="token operator">-</span>aplus<span class="token operator">-</span>tests 
promises<span class="token operator">-</span>aplus<span class="token operator">-</span>tests MyPromise<span class="token punctuation">.</span>js
</code></pre></div><p><img src="data:image/png;base64,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" alt=""></p> <h2 id="promie实例方法"><a href="#promie实例方法" class="header-anchor">#</a> promie实例方法</h2> <h3 id="catch"><a href="#catch" class="header-anchor">#</a> catch</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">catch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">onFullifilledFn</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> onFullifilledFn<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="finally"><a href="#finally" class="header-anchor">#</a> finally</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token class-name">MyPromise</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function-variable function">finally</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">cb</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> MyPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> res
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token parameter">err</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> MyPromise<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token function">cb</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">throw</span> err
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="promise的静态方法"><a href="#promise的静态方法" class="header-anchor">#</a> promise的静态方法</h2> <h3 id="promise-resolve"><a href="#promise-resolve" class="header-anchor">#</a> Promise.resolve</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">resolve</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">value</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="promise-reject"><a href="#promise-reject" class="header-anchor">#</a> Promise.reject</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">reject</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">reason</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">reject</span><span class="token punctuation">(</span>reason<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="promise-race"><a href="#promise-race" class="header-anchor">#</a> Promise.race</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">race</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> promise <span class="token operator">=</span> promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      promise<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="promise-all"><a href="#promise-all" class="header-anchor">#</a> Promise.all</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code>MyPromise<span class="token punctuation">.</span><span class="token function-variable function">all</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">promises</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token keyword">let</span> index <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> promise <span class="token operator">=</span> promises<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      promise<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token parameter">res</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        index<span class="token operator">++</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">===</span> promises<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> reject<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="gitalk-container"><div id="gitalk-container"></div></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/JavaScript/脚本化http.html">
        脚本化http
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.741f6848.js" defer></script><script src="/assets/js/2.5b9869e2.js" defer></script><script src="/assets/js/8.44809fb9.js" defer></script><script src="/assets/js/3.f51a2f18.js" defer></script>
  </body>
</html>
