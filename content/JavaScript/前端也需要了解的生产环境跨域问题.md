
# å‰åç«¯éƒ½ç”¨å¾—ä¸Šçš„corsè®¾ç½®

å…³äºå‰ç«¯å¦‚ä½•å¤„ç†è·¨åŸŸé—®é¢˜ï¼Œæ¨èå¤§å®¶çœ‹è¿™ä¸€ç¯‡æ–‡ç« [ä¹ç§è·¨åŸŸæ–¹å¼å®ç°åŸç†ï¼ˆå®Œæ•´ç‰ˆï¼‰](https://github.com/ljianshu/Blog/issues/55)ï¼Œè¦†ç›–äº†å¤šç§è·¨åŸŸè§£å†³æ–¹æ³•ã€‚

æ­¤ç¯‡æ–‡ç« ä¸»è¦é’ˆå¯¹ä¸­é—´çš„ä¸€ç‚¹ï¼Œå¦‚ä½•é€šè¿‡`cors`æ¥å®ç°ã€‚ä»¥åŠå‡ºç°çš„å„ç§è·¨åŸŸæŠ¥é”™çš„ä¿¡æ¯å¦‚ä½•å¤„ç†ã€‚æ–‡ä¸­æ‰€æœ‰ä»£ç åŸºäº`node`å®ç°ï¼ŒåŒæ ·é€‚åˆäº`javaã€php`ä»¥åŠ`nginx`ç­‰ã€‚

æœ€è¿‘é…åˆæœåŠ¡ç«¯åŒå­¦å¤„ç†äº†ä¸¤æ¬¡çº¿ä¸Šè·¨åŸŸé—®é¢˜ã€‚åœ¨é…åˆæœåŠ¡ç«¯åŒå­¦è§£å†³çš„è¿‡ç¨‹ä¸­å¹¶ä¸æ˜¯å¾ˆé¡ºåˆ©ï¼Œè¸©åˆ°äº†ä¸€äº›å‘ï¼Œå› æ­¤ç—›å®šæ€ç—›ï¼Œå°†å…¶æ•´ç†å‡ºæ¥ã€‚


## ç®€å•è¯·æ±‚å’Œé¢„æ£€è¯·æ±‚(å¤æ‚è¯·æ±‚)

ç±»å‹        | å®šä¹‰
------------|--------------------------
ç®€å•è¯·æ±‚     |1ã€ä½¿ç”¨`GETã€HEADã€POST`ä¸‰ç§æ–¹æ³•ä¹‹ä¸€ <br/> 2ã€ä¸å¾—äººä¸ºè®¾ç½®è¯¥é›†åˆä¹‹å¤–çš„å…¶ä»–é¦–éƒ¨å­—æ®µã€‚è¯¥é›†åˆä¸º`Acceptã€Accept-Languageã€Content-Languageã€Content-Typeï¼ˆéœ€è¦æ³¨æ„é¢å¤–çš„é™åˆ¶ï¼‰ ã€DPRã€Downlinkã€Save-Dataã€Viewport-Widthã€Width`<br/> 3ã€`Content-Type` çš„å€¼ä»…é™äºä¸‹åˆ—ä¸‰è€…ä¹‹ä¸€ã€‚`text/plainã€multipart/form-dataã€application/x-www-form-urlencoded`<br/>4ã€è¯·æ±‚ä¸­çš„ä»»æ„XMLHttpRequestUpload å¯¹è±¡å‡æ²¡æœ‰æ³¨å†Œä»»ä½•äº‹ä»¶ç›‘å¬å™¨ï¼›XMLHttpRequestUpload å¯¹è±¡å¯ä»¥ä½¿ç”¨ [XMLHttpRequest.upload](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/upload) å±æ€§è®¿é—®ã€‚<br/> 5ã€è¯·æ±‚ä¸­æ²¡æœ‰ä½¿ç”¨ [ReadableStream](https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream) å¯¹è±¡ã€‚
é¢„æ£€è¯·æ±‚     |1ã€ä½¿ç”¨`PUTã€DELETEã€CONNECTã€OPTIONSã€TRACEã€PATCH` <br/> 2ã€ä½¿ç”¨äº† ç®€å•è¯·æ±‚ä¸­ ç¬¬äºŒæ¡ä¹‹å¤–çš„å­—æ®µ <br/>3ã€`Content-Type`çš„å€¼ä¸æ˜¯ä¸‹åˆ—ä¸‰è€…ä¹‹ä¸€ã€‚`text/plainã€multipart/form-dataã€application/x-www-form-urlencoded`ã€‚æœ€å¸¸è§æ˜¯`application/json`<br/>4ã€è¯·æ±‚ä¸­çš„XMLHttpRequestUpload å¯¹è±¡æ³¨å†Œäº†ä»»æ„å¤šä¸ªäº‹ä»¶ç›‘å¬å™¨ã€‚<br/> 5ã€è¯·æ±‚ä¸­ä½¿ç”¨äº†[ReadableStream](https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream) å¯¹è±¡ã€‚

é¢„æ£€è¯·æ±‚ å’Œç®€å•è¯·æ±‚çš„åŒºåˆ«åœ¨äºã€‚é¢„æ£€è¯·æ±‚ è¦æ±‚å¿…é¡»é¦–å…ˆä½¿ç”¨ `OPTIONS` æ–¹æ³•å‘èµ·ä¸€ä¸ªé¢„æ£€è¯·æ±‚åˆ°æœåŠ¡å™¨ï¼Œä»¥è·çŸ¥æœåŠ¡å™¨æ˜¯å¦å…è®¸è¯¥å®é™…è¯·æ±‚ã€‚"é¢„æ£€è¯·æ±‚â€œçš„ä½¿ç”¨ï¼Œå¯ä»¥é¿å…è·¨åŸŸè¯·æ±‚å¯¹æœåŠ¡å™¨çš„ç”¨æˆ·æ•°æ®äº§ç”Ÿæœªé¢„æœŸçš„å½±å“.

ä»¥ä¸Šæ•´ç†è‡ª MDN [HTTPè®¿é—®æ§åˆ¶ï¼ˆCORSï¼‰](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS)ã€‚


## å…·ä½“åœºæ™¯åŠä»£ç å®ç°
åœ¨å…·ä½“ä»£ç å®ç°ä¹‹å‰ï¼Œå…ˆæ¥çœ‹ä¸€ä¸‹å…³äºè·¨åŸŸé—®é¢˜çš„å“åº”é¦–éƒ¨å­—æ®µå«ä¹‰:

<div style="width:360px"></div> |   å«ä¹‰
---------------|------------------
`Access-Control-Allow-Origin: <origin> | *`   | origin å‚æ•°çš„å€¼æŒ‡å®šäº†å…è®¸è®¿é—®è¯¥èµ„æºçš„å¤–åŸŸ URIã€‚è¡¨ç¤ºå…è®¸æ¥è‡ªæ‰€æœ‰åŸŸçš„è¯·æ±‚
`Access-Control-Expose-Headers: X-My-Custom-Header, X-Another-Custom-Header`               |åœ¨è·¨åŸŸè®¿é—®æ—¶ï¼Œå‰ç«¯é€šè¿‡getResponseHeader()æ–¹æ³•åªèƒ½æ‹¿åˆ°ä¸€äº›æœ€åŸºæœ¬çš„å“åº”å¤´ï¼ŒCache-Controlã€Content-Languageã€Content-Typeã€Expiresã€Last-Modifiedã€Pragmaï¼Œå¦‚æœè¦è®¿é—®å…¶ä»–å¤´ï¼Œåˆ™éœ€è¦æœåŠ¡å™¨è®¾ç½®æœ¬å“åº”å¤´ã€‚ä¸å¸¸ç”¨
`Access-Control-Max-Age: <delta-seconds>`     |Access-Control-Max-Age å¤´æŒ‡å®šäº†preflightè¯·æ±‚çš„ç»“æœèƒ½å¤Ÿè¢«ç¼“å­˜å¤šä¹…
`Access-Control-Allow-Credentials: true`      |æŒ‡å®šäº†å½“æµè§ˆå™¨çš„credentialsè®¾ç½®ä¸ºtrueæ—¶æ˜¯å¦å…è®¸æµè§ˆå™¨è¯»å–responseçš„å†…å®¹ã€‚æ³¨æ„ï¼šç®€å• GET è¯·æ±‚ä¸ä¼šè¢«é¢„æ£€ï¼›å¦‚æœå¯¹æ­¤ç±»è¯·æ±‚çš„å“åº”ä¸­ä¸åŒ…å«è¯¥å­—æ®µï¼Œè¿™ä¸ªå“åº”å°†è¢«å¿½ç•¥æ‰ï¼Œå¹¶ä¸”æµè§ˆå™¨ä¹Ÿä¸ä¼šå°†ç›¸åº”å†…å®¹è¿”å›ç»™ç½‘é¡µ
`Access-Control-Allow-Methods: <method>[, <method>]*`|æŒ‡æ˜äº†å®é™…è¯·æ±‚æ‰€å…è®¸ä½¿ç”¨çš„ HTTP æ–¹æ³•
`Access-Control-Allow-Headers: <field-name>[, <field-name>]*`|æŒ‡æ˜äº†å®é™…è¯·æ±‚ä¸­å…è®¸æºå¸¦çš„é¦–éƒ¨å­—æ®µã€‚


### ç®€å•è¯·æ±‚
å¯¹äºç®€å•è¯·æ±‚ï¼Œå…¶å®åªéœ€è¦è®¾ç½® `Access-Control-Allow-Origin` ä¸º`*`æˆ–è€…æŒ‡å®šçš„åŸŸåå³å¯å¤„ç†ã€‚
```js vue.js
export default {
  name: "app",
  methods: {
    /* ç®€å•è¯·æ±‚ */
    simpleGet() {
      axios({
        url: "http://localhost:3000/simple-get",
        method: "get",
        params: { message: "æ­¤è¯·æ±‚ä¸ºgetè¯·æ±‚" }
      }).then(res => {
        console.log(res);
      });
    },
    simplePost() {
      const data = new URLSearchParams();
      data.append("message", "æ­¤æ—¶æ˜¯postçš„ç®€å•è¯·æ±‚");
      axios({
        url: "http://localhost:3000/simple-post",
        method: "post",
        data: data
      }).then(res => {
        console.log(res);
      });
    }
  }
};
```
```js app.js
const http = require('http')
const { URLSearchParams, URL } = require('url')
const querystring = require('querystring');
const serve = http.createServer()
const resloveData = req => {
  let data = "";
  const { method, url } = req
  const { pathname, search } = new URL(url, 'http://localhost:300')
  return new Promise(reslove => {
    switch (method) {
      case "GET":
        data = querystring.parse(search.slice(1))
        reslove({ pathname: pathname, method: method, data: data })
        break;

      case "POST":
        req.on('data', chunk => {
          data += chunk
        })
        req.on('end', () => {
          data = decodeURIComponent(data)
          try {
            data = JSON.parse(data)
          } catch (error) {
            data = querystring.parse(data)
          }
          reslove({ pathname: pathname, method: method, data: data })
        })
        break;

      default:
        reslove({ pathname: pathname, method: method })
    }
  })
}

serve.on('request', async (req, res) => {
  const { pathname, data, method } = await resloveData(req)
  if (pathname === '/simple-get') {
    res.setHeader('Access-Control-Allow-Origin', '*') //è®¾ç½®å…è®¸è·¨åŸŸçš„è¯·æ±‚å¤´
    res.writeHead(200, { 'Content-Type': 'text/plain;charset=utf-8' });
    res.end(JSON.stringify(data))
    return
  }
  if (pathname === '/simple-post') {
    res.setHeader('Access-Control-Allow-Origin', '*') //è®¾ç½®å…è®¸è·¨åŸŸçš„è¯·æ±‚å¤´
    res.writeHead(200, { 'Content-Type': 'text/plain;charset=utf-8' });
    res.end(JSON.stringify(data))
  }
})

serve.listen('3000', function () {
  console.log('ğŸ serve is runing......')
})
```
### é¢„æ£€è¯·æ±‚
ä¸‹é¢æ˜¯ä¸€ä¸ªé¢„æ£€è¯·æ±‚çš„ä¾‹å­ï¼Œæˆ‘ä»¬çŸ¥é“åªè¦ä½¿ç”¨äº†`content-type`ä¸­é™¤äº†`text/plainã€multipart/form-dataã€application/x-www-form-urlencoded`ä¹‹å¤–çš„å®šä¹‰ï¼Œé‚£ä¹ˆå°±æ˜¯ä¸€ä¸ªå¤æ‚è¯·æ±‚ã€‚`axios`ä¸­`post`è¯·æ±‚çš„`Content-Type`é»˜è®¤ä¸º`application/json`ï¼Œå³ä¸ºé¢„æ£€è¯·æ±‚ã€‚
 
æ–°å¢ä»£ç å¦‚ä¸‹:
```js app.vue
export default{
  methods:{
    /* æ–°å¢ */
    preflightPost() {
      const data = {
        message: "æ­¤æ—¶æ˜¯ä¸€ä¸ªpostçš„å¤æ‚è¯·æ±‚ä¼šå‘é€é¢„æ£€è¯·æ±‚"
      };
      axios({
        url: "http://localhost:3000/preflight-post",
        method: "post",
        data: data
      }).then(res => {
        console.log(res);
      });
    }
  }
}
```
```js app.js
if (pathname == '/preflight-post') {
  res.setHeader('Access-Control-Allow-Origin', '*')
  res.end(JSON.stringify(data))
}
```
æ­¤æ—¶ä¼šå‡ºç°æŠ¥é”™ä¿¡æ¯å¦‚ä¸‹ï¼š
::: danger
Request header field content-type is not allowed by Access-Control-Allow-Headers in preflight response
:::
è¿™æ˜¯å› ä¸ºæˆ‘ä»¬æ›´æ”¹äº†`Content-Type`æœåŠ¡ç«¯æœªè¿›è¡Œå“åº”å¤„ç†ã€‚

å¦‚æœæˆ‘ä»¬è‡ªå®šä¹‰äº†å…¶ä»–çš„è¯·æ±‚å¤´å­—æ®µ(å¦‚ `Authorization`) ä¹Ÿä¼šæŠ¥åŒæ ·çš„é”™è¯¯ã€‚åªéœ€è¦å°†å¯¹åº”çš„å­—æ®µåŠ å…¥åˆ° `Access-Control-Allow-Headers` æˆ–è€…è®¾ç½®ä¸º`*`æˆ–è€…åŒ…å«ç›¸åº”çš„è¯·æ±‚å¤´ã€‚

æœåŠ¡ç«¯åº”è¯¥æ›´æ”¹ä¸º:
```js
if (pathname == '/preflight-post') {
  res.setHeader('Access-Control-Allow-Origin', '*')
  res.setHeader("Access-Control-Allow-Headers", "*");
  res.writeHead(200,{'Content-Type':'text/plain;charset=utf-8'})
  res.end(JSON.stringify(data))
}
```
å…¶å®æŒ‰ç…§ä¸Šé¢çš„é…ç½®ä¹‹åå¯¹äº `options` è¯·æ±‚ï¼ŒæœåŠ¡å™¨é»˜è®¤å¸®æˆ‘ä»¬å¤„ç†ä¸ºè¿”å›æˆåŠŸã€‚æ·»åŠ ä»£ç å¦‚ä¸‹
```js
if (pathname == '/preflight-post') {
  res.setHeader('Access-Control-Allow-Origin', '*')
  res.setHeader("Access-Control-Allow-Headers", "*");
  if (method === 'OPTIONS') {
    res.status = 200
    res.end('hello world')
  }
  res.writeHead(200, { 'Content-Type': 'text/plain;charset=utf-8' })
  res.end(JSON.stringify(data))
}
```
å¯ä»¥æ›´æ”¹`res.end()`æ¥å—ä»»ä½•çš„ä¿¡æ¯ï¼Œå¹¶ä¸ä¼šå½±å“è·¨åŸŸçš„è®¾ç½®ï¼Œå½“ç„¶`options`è¯·æ±‚çš„è¿”å›å€¼è™½ç„¶ä¼šåœ¨æµè§ˆå™¨æ˜¾ç¤ºï¼Œä½†è·å–ä¸åˆ°ã€‚

### ç®€å•è¯·æ±‚(æºå¸¦cookie)
ä¸Šé¢çš„ä¾‹å­ä¸­æˆ‘ä»¬éƒ½ä¸éœ€è¦æºå¸¦`cookie`ã€‚è€Œå¯¹äºè·¨åŸŸè¯·æ±‚å¦‚æœéœ€è¦æºå¸¦`cookie`ã€‚éœ€è¦å‰ç«¯å£°æ˜`withCredentials:true`ã€‚æ–°å¢ä»£ç å¦‚ä¸‹
```js vue.js
simpleGetWithCookie() {
  axios({
    url: "http://localhost:3000/simple-with-cookie",
    method: "get",
    params: { message: "æ­¤è¯·æ±‚ä¸ºæºå¸¦cookieçš„getè¯·æ±‚" },
    withCredentials: true
  }).then(res => {
    console.log(res);
  });
},
simplePostWithCookie() {
  const data = new URLSearchParams();
  data.append("message", "æ­¤æ—¶æ˜¯postçš„ç®€å•è¯·æ±‚");
  axios({
    url: "http://localhost:3000/simple-with-cookie",
    method: "post",
    data: data,
    withCredentials: true
  }).then(res => {
    console.log(res);
  });
},
```
```js app.js
if (pathname === '/simple-with-cookie') {
  res.setHeader('Access-Control-Allow-Origin', '*') //è®¾ç½®å…è®¸è·¨åŸŸçš„è¯·æ±‚å¤´
  res.end(JSON.stringify(data))
}
```
:::danger
The value of the 'Access-Control-Allow-Origin' header in the response must not be the wildcard '*' when the request's credentials mode is 'include'. The credentials mode of requests initiated by the XMLHttpRequest is controlled by the withCredentials attribute
:::
è¿™æ˜¯å› ä¸ºå½“æˆ‘ä»¬æ˜¾å¼å£°æ˜è·¨åŸŸæºå¸¦`cookie`æ—¶ã€‚æœåŠ¡ç«¯å“åº”å¤´`Access-Control-Allow-Origin`ä¸èƒ½ä¸º`*`,åŒæ—¶æœåŠ¡ç«¯ä¹Ÿéœ€è¦æ˜¾å¼å£°æ˜æ¥å—`cookie`ã€‚æ›´æ”¹æœåŠ¡ç«¯ä»£ç å¦‚ä¸‹å³å¯è§£å†³ï¼š
```js
if (pathname === '/simple-with-cookie') {
  res.setHeader('Access-Control-Allow-Origin', 'http://localhost:8080') //è®¾ç½®å…è®¸è·¨åŸŸçš„è¯·æ±‚å¤´
  res.setHeader('Access-Control-Allow-Credentials', true)
  res.end(JSON.stringify(data))
}
```
### é¢„æ£€è¯·æ±‚(æºå¸¦cookie)
æ–°å¢ä»£ç å¦‚ä¸‹:
```js app.vue
preflightPostWithCookie() {
  const data = {
    message: "æ­¤æ—¶æ˜¯ä¸€ä¸ªå†™åˆ°cookieçš„postçš„é¢„æ£€è¯·æ±‚"
  };
  axios({
    url: "http://localhost:3000/preflight-post-with-cookie",
    method: "post",
    data: data,
    withCredentials:true
  }).then(res => {
    console.log(res);
  });
}
```
```js app.js
if (pathname === '/preflight-post-with-cookie') {
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");
  res.setHeader('Access-Control-Allow-Origin', 'http://localhost:8080') //è®¾ç½®å…è®¸è·¨åŸŸçš„è¯·æ±‚å¤´
  res.setHeader('Access-Control-Allow-Credentials', true) //  è®¾ç½®æºå¸¦cookie
  if(res.method==='OPTIONS'){
    res.status = 200
    res.end()
  }
  res.end(JSON.stringify(data))
}
```
::: warning
æ­¤å¤„éœ€è¦æ³¨æ„ã€‚æºå¸¦`cookie`çš„é¢„æ£€è¯·æ±‚åœ¨è®¾ç½®æ—¶å¦‚æœå°†`Access-Control-Allow-Headers`è®¾ä¸º`*`æ˜¯ä¸èµ·ä½œç”¨çš„ï¼Œåªèƒ½æ˜¾å¼æŒ‡å®šæ‰èƒ½ç”Ÿæ•ˆ
:::


## ç»Ÿä¸€å¤„ç†å’Œnginxä¸­é…ç½®

ä¸Šé¢çš„ä»£ç ä¸­ä¸ºäº†ç†è§£æ–¹ä¾¿ï¼Œåœ¨æ¯ä¸€ä¸ªæ¥å£ä¸­è¿›è¡Œè·¨åŸŸçš„å¤„ç†ã€‚å®é™…ä¸Šæ›´å¤šçš„æ˜¯åœ¨æ¥å£å‰è¿›è¡Œç»Ÿä¸€çš„å¤„ç†ã€‚å¦‚ä¸‹ï¼š
```js app.js
serve.on('request', async (req, res) => {
  res.setHeader('Access-Control-Allow-Origin', 'http://localhost:8080');
  res.setHeader("Access-Control-Allow-Headers", "Content-Type");
  res.setHeader('Access-Control-Allow-Credentials', true) //  è®¾ç½®æºå¸¦cookie
  const { pathname, data, method } = await resloveData(req)
  if (pathname === '/preflight-post-with-cookie') {
    res.end(JSON.stringify(data))
  }
})
```
é€šå¸¸æƒ…å†µä¸‹ï¼Œä¹Ÿä¸ä¼šå°†è·¨åŸŸè®¾ç½®çš„å†™æ­»åœ¨åç«¯çš„ä»£ç ä¸­ï¼Œè€Œæ˜¯é€šè¿‡ `nginx`è¿›è¡Œé…ç½®ã€‚æ­¤æ—¶çš„è®¾ç½®å’Œä»£ç ä¸­ä¸€æ ·ã€‚å¦‚ä¸‹:

**æ³¨æ„åœ¨`nginx`çš„é…ç½®ä¸Šå¿…é¡»è¦æ·»åŠ `always`**ã€‚å› ä¸º`nginx`é»˜è®¤å¯¹äº`401ã€500`ä¹‹ç±»çš„çŠ¶æ€æ˜¯ä¸æ·»åŠ é…ç½®çš„è·¨åŸŸä¿¡æ¯çš„ã€‚å› æ­¤ä¼šå¯¼è‡´å‰ç«¯åœ¨æ¥å£`401ã€500`ä¹‹ç±»æ—¶è·å–ä¸åˆ°çŠ¶æ€ç ï¼Œä¸èƒ½åšå‡ºæ­£ç¡®çš„åˆ¤æ–­ã€‚
```js
server {
  //... some code
    location / {
      add_header 'Access-Control-Allow-Origin' 'http://localhost:8080' always;
      add_header 'Access-Control-Allow-Credentials' true always;
      add_header 'Access-Control-Allow-Headers' Content-Type always;
      //...some code
    }
}
```


## æºç åœ°å€
  ä»¥ä¸Šæ‰€æœ‰ä»£ç [cross-domain](https://github.com/xiaopingbuxiao/demo/tree/master/cross-domain)

<Gitalk></Gitalk>





























