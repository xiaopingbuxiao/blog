
# 前端也需要了解的生产环境跨域问题

关于前端如何处理跨域问题，推荐大家看这一篇文章[九种跨域方式实现原理（完整版）](https://github.com/ljianshu/Blog/issues/55)，含金量比较高，覆盖了多种跨域解决方法。

此篇文章主要针对中间的一点，如何通过`cors`来实现。以及出现的各种跨域报错的信息如何处理。文中所有代码基于`node`实现，同样适合于`java、php`等。


## 背景
最近配合服务端同学开发的过程中出现了两次跨域问题。在配合服务端同学解决的问题中并不是很顺利，踩到了一些坑，因此痛定思痛，将其整理出来。观看此篇文章之前，建议大家先读一下[九种跨域方式实现原理（完整版）](https://github.com/ljianshu/Blog/issues/55)。


## 简单请求和预检请求

类型        | 定义
------------|--------------------------
简单请求     |1、使用`GET、HEAD、POST`三种方法之一 <br/> 2、不得人为设置该集合之外的其他首部字段。该集合为`Accept、Accept-Language、Content-Language、Content-Type（需要注意额外的限制） 、DPR、Downlink、Save-Data、Viewport-Width、Width`<br/> 3、`Content-Type` 的值仅限于下列三者之一。`text/plain、multipart/form-data、application/x-www-form-urlencoded`<br/>4、请求中的任意XMLHttpRequestUpload 对象均没有注册任何事件监听器；XMLHttpRequestUpload 对象可以使用 [XMLHttpRequest.upload](https://developer.mozilla.org/zh-CN/docs/Web/API/XMLHttpRequest/upload) 属性访问。<br/> 5、请求中没有使用 [ReadableStream](https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream) 对象。
预检请求     |1、使用`PUT、DELETE、CONNECT、OPTIONS、TRACE、PATCH` <br/> 2、使用了 简单请求中 第二条之外的字段 <br/>3、`Content-Type`的值不是下列三者之一。`text/plain、multipart/form-data、application/x-www-form-urlencoded`。最常见是`application/json`<br/>4、请求中的XMLHttpRequestUpload 对象注册了任意多个事件监听器。<br/> 5、请求中使用了[ReadableStream](https://developer.mozilla.org/zh-CN/docs/Web/API/ReadableStream) 对象。

预检请求 和简单请求的区别在于。预检请求 要求必须首先使用 `OPTIONS` 方法发起一个预检请求到服务器，以获知服务器是否允许该实际请求。"预检请求“的使用，可以避免跨域请求对服务器的用户数据产生未预期的影响.

以上整理自 MDN [HTTP访问控制（CORS）](https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Access_control_CORS)。


## 具体场景及代码实现

在具体代码实现之前，先来看一下关于跨域问题的响应首部字段含义:

<div style="width:360px"></div> |   含义
---------------|------------------
`Access-Control-Allow-Origin: <origin> | *`   | origin 参数的值指定了允许访问该资源的外域 URI。表示允许来自所有域的请求。
`Access-Control-Expose-Headers`               |在跨域访问时，前端通过getResponseHeader()方法只能拿到一些最基本的响应头，Cache-Control、Content-Language、Content-Type、Expires、Last-Modified、Pragma，如果要访问其他头，则需要服务器设置本响应头。不常用
`Access-Control-Max-Age: <delta-seconds>`     |Access-Control-Max-Age 头指定了preflight请求的结果能够被缓存多久，一般无需设置
`Access-Control-Allow-Credentials: true`      |指定了当浏览器的credentials设置为true时是否允许浏览器读取response的内容。注意：简单 GET 请求不会被预检；如果对此类请求的响应中不包含该字段，这个响应将被忽略掉，并且浏览器也不会将相应内容返回给网页
`Access-Control-Allow-Methods: <method>[, <method>]*`|指明了实际请求所允许使用的 HTTP 方法
`Access-Control-Allow-Headers: <field-name>[, <field-name>]*`|指明了实际请求中允许携带的首部字段。




























